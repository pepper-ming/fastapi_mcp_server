# FastAPI MCP Server 第一週任務細分計畫

## 總體目標

建立 FastAPI MCP Server 的基礎架構，包含專案初始化、基礎 MCP 整合、Docker 化部署，以及完整的開發環境配置。

## 任務細分（第 1-7 天）

### 第 1 天：專案環境初始化

#### 任務 1.1：開發環境準備
**預計時間：2 小時**

```bash
# 安裝 Poetry（現代 Python 依賴管理）
curl -sSL https://install.python-poetry.org | python3 -

# 驗證安裝
poetry --version
python --version  # 確保 Python 3.11+
```

#### 任務 1.2：專案結構建立
**預計時間：1 小時**

```bash
# 建立專案目錄
mkdir fastapi-mcp-server
cd fastapi-mcp-server

# 初始化 Poetry 專案
poetry init --name fastapi-mcp-server --version 0.1.0 --description "統計分析與機器學習推論的 MCP Server"

# 建立專案結構
mkdir -p app/{api,core,models,services,utils}
mkdir -p tests/{api,integration,unit}
mkdir -p docs
mkdir -p scripts

# 建立基礎檔案
touch app/__init__.py
touch app/main.py
touch app/api/__init__.py
touch app/core/__init__.py
touch app/models/__init__.py
touch app/services/__init__.py
touch app/utils/__init__.py
touch tests/__init__.py
touch README.md
touch .env.example
touch .gitignore
```

#### 任務 1.3：Git 版本控制設置
**預計時間：30 分鐘**

```bash
# 初始化 Git
git init

# 建立 .gitignore
cat > .gitignore << EOF
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
env/
venv/
ENV/
env.bak/
venv.bak/
.venv/

# FastAPI
.env
.env.local
.env.production

# IDEs
.vscode/
.idea/
*.swp
*.swo
*~

# OS
.DS_Store
Thumbs.db

# Database
*.db
*.sqlite3

# Docker
Dockerfile.dev

# Logs
*.log
logs/

# Testing
.pytest_cache/
.coverage
htmlcov/

# Documentation
docs/_build/
EOF

# 初始提交
git add .
git commit -m "feat: 初始化專案結構"
```

### 第 2 天：核心依賴安裝與配置

#### 任務 2.1：安裝核心依賴
**預計時間：1 小時**

```bash
# 安裝生產依賴
poetry add fastapi[standard]==0.115.0
poetry add fastapi-mcp==0.3.0
poetry add uvicorn[standard]==0.24.0
poetry add pydantic==2.5.0
poetry add pydantic-settings==2.1.0
poetry add sqlalchemy==2.0.23
poetry add asyncpg==0.29.0
poetry add redis==5.0.1

# 安裝開發依賴
poetry add --group dev pytest==7.4.0
poetry add --group dev pytest-asyncio==0.21.0
poetry add --group dev pytest-cov==4.1.0
poetry add --group dev ruff==0.1.15
poetry add --group dev mypy==1.8.0
poetry add --group dev pre-commit==3.6.0
poetry add --group dev httpx==0.25.0  # 用於測試 HTTP 請求

# 安裝統計和機器學習依賴
poetry add numpy==1.26.0
poetry add pandas==2.1.0
poetry add scikit-learn==1.4.0
poetry add scipy==1.11.0
```

#### 任務 2.2：配置開發工具
**預計時間：1 小時**

```toml
# 建立 pyproject.toml 配置
cat >> pyproject.toml << EOF

[tool.ruff]
line-length = 88
target-version = "py311"
select = ["E", "F", "I", "N", "W", "UP"]

[tool.ruff.isort]
known-first-party = ["app"]

[tool.mypy]
python_version = "3.11"
strict = true
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = true
plugins = ["pydantic.mypy"]

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py", "*_test.py"]
python_classes = ["Test*"]
python_functions = ["test_*"]
asyncio_mode = "auto"
addopts = [
    "-ra",
    "--strict-markers",
    "--strict-config",
    "--cov=app",
    "--cov-report=term-missing:skip-covered",
    "--cov-report=html:htmlcov",
    "--cov-report=xml",
]

[tool.coverage.run]
source = ["app"]
branch = true

[tool.coverage.report]
exclude_lines = [
    "pragma: no cover",
    "def __repr__",
    "if self.debug:",
    "if settings.DEBUG",
    "raise AssertionError",
    "raise NotImplementedError",
    "if 0:",
    "if __name__ == .__main__.:",
    "class .*\bProtocol\\):",
    "@(abc\\.)?abstractmethod",
]
EOF
```

#### 任務 2.3：Pre-commit 設置
**預計時間：30 分鐘**

```yaml
# 建立 .pre-commit-config.yaml
cat > .pre-commit-config.yaml << EOF
repos:
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
      - id: end-of-file-fixer
      - id: check-merge-conflict
      - id: check-case-conflict
      - id: check-json
      - id: check-toml
      - id: check-yaml
      - id: pretty-format-json
        args: ["--autofix"]
      - id: check-added-large-files

  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.1.15
    hooks:
      - id: ruff
        args: [--fix]
      - id: ruff-format

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        additional_dependencies: [pydantic]
EOF

# 安裝 pre-commit hooks
poetry run pre-commit install
```

### 第 3 天：FastAPI 基礎應用建立

#### 任務 3.1：建立設定管理
**預計時間：1.5 小時**

```python
# app/core/settings.py
from functools import lru_cache
from typing import Optional

from pydantic import Field
from pydantic_settings import BaseSettings, SettingsConfigDict


class Settings(BaseSettings):
    """應用程式設定"""
    
    model_config = SettingsConfigDict(
        env_file=".env",
        env_ignore_empty=True,
        extra="ignore"
    )
    
    # 應用程式設定
    app_name: str = "FastAPI MCP Server"
    app_version: str = "0.1.0"
    debug: bool = False
    
    # 伺服器設定
    host: str = "0.0.0.0"
    port: int = 8000
    reload: bool = False
    
    # 資料庫設定
    database_url: str = Field(
        default="sqlite:///./app.db",
        description="資料庫連線 URL"
    )
    database_echo: bool = False
    
    # Redis 設定
    redis_url: str = Field(
        default="redis://localhost:6379/0",
        description="Redis 連線 URL"
    )
    
    # MCP 設定
    mcp_name: str = "Statistical Analysis MCP"
    mcp_description: str = "專業級統計分析與機器學習推論服務"
    mcp_version: str = "1.0.0"
    
    # CORS 設定
    cors_origins: list[str] = ["*"]
    cors_allow_credentials: bool = True
    cors_allow_methods: list[str] = ["*"]
    cors_allow_headers: list[str] = ["*"]


@lru_cache()
def get_settings() -> Settings:
    """獲取應用程式設定（含快取）"""
    return Settings()
```

#### 任務 3.2：建立 FastAPI 主程式
**預計時間：1 小時**

```python
# app/main.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from fastapi_mcp import FastApiMCP

from app.core.settings import get_settings

settings = get_settings()

# 建立 FastAPI 應用程式
app = FastAPI(
    title=settings.app_name,
    version=settings.app_version,
    description="基於 Model Context Protocol 的統計分析與機器學習推論服務平台",
    debug=settings.debug,
)

# 添加 CORS 中介軟體
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.cors_origins,
    allow_credentials=settings.cors_allow_credentials,
    allow_methods=settings.cors_allow_methods,
    allow_headers=settings.cors_allow_headers,
)

# 初始化 MCP 整合
mcp = FastApiMCP(
    app,
    name=settings.mcp_name,
    description=settings.mcp_description,
)

# 基礎路由
@app.get("/", tags=["基礎"])
async def root():
    """根端點 - 服務狀態"""
    return {
        "service": settings.app_name,
        "version": settings.app_version,
        "status": "running",
        "mcp_endpoint": "/mcp"
    }

@app.get("/health", tags=["基礎"])
async def health_check():
    """健康檢查端點"""
    return {
        "status": "healthy",
        "service": settings.app_name,
        "version": settings.app_version
    }

# 掛載 MCP 服務（使用最新 HTTP transport）
mcp.mount_http()

if __name__ == "__main__":
    import uvicorn
    
    uvicorn.run(
        "app.main:app",
        host=settings.host,
        port=settings.port,
        reload=settings.reload,
        log_level="debug" if settings.debug else "info",
    )
```

#### 任務 3.3：建立環境變數範本
**預計時間：30 分鐘**

```env
# .env.example
# 複製為 .env 並根據需求修改

# 應用程式設定
APP_NAME=FastAPI MCP Server
APP_VERSION=0.1.0
DEBUG=true

# 伺服器設定
HOST=0.0.0.0
PORT=8000
RELOAD=true

# 資料庫設定
DATABASE_URL=sqlite:///./app.db
DATABASE_ECHO=false

# Redis 設定
REDIS_URL=redis://localhost:6379/0

# MCP 設定
MCP_NAME=Statistical Analysis MCP
MCP_DESCRIPTION=專業級統計分析與機器學習推論服務
MCP_VERSION=1.0.0

# CORS 設定
CORS_ORIGINS=["*"]
```

### 第 4 天：基礎統計 API 端點建立

#### 任務 4.1：建立資料模型
**預計時間：1.5 小時**

```python
# app/models/statistics.py
from typing import List, Optional, Union
from pydantic import BaseModel, Field


class StatisticalDataRequest(BaseModel):
    """統計資料請求模型"""
    
    data: List[Union[int, float]] = Field(
        ...,
        description="數值資料陣列",
        min_items=1,
        example=[1.2, 2.3, 3.4, 4.5, 5.6]
    )
    
    confidence_level: float = Field(
        default=0.95,
        description="信賴水準",
        ge=0.01,
        le=0.99,
        example=0.95
    )


class DescriptiveStatistics(BaseModel):
    """描述性統計結果模型"""
    
    count: int = Field(description="資料點數量")
    mean: float = Field(description="算術平均數")
    median: float = Field(description="中位數")
    mode: Optional[float] = Field(description="眾數（如存在）")
    std_dev: float = Field(description="標準差")
    variance: float = Field(description="變異數")
    min_value: float = Field(description="最小值")
    max_value: float = Field(description="最大值")
    range_value: float = Field(description="全距")
    q1: float = Field(description="第一四分位數")
    q3: float = Field(description="第三四分位數")
    iqr: float = Field(description="四分位距")
    skewness: float = Field(description="偏度")
    kurtosis: float = Field(description="峰度")
    
    confidence_interval: dict = Field(
        description="平均數信賴區間",
        example={"lower": 2.5, "upper": 4.5, "level": 0.95}
    )


class HypothesisTestRequest(BaseModel):
    """假設檢定請求模型"""
    
    sample_data: List[Union[int, float]] = Field(
        ...,
        description="樣本資料",
        min_items=2
    )
    
    test_type: str = Field(
        default="one_sample_t",
        description="檢定類型",
        example="one_sample_t"
    )
    
    null_hypothesis_value: float = Field(
        default=0.0,
        description="虛無假設數值",
        example=0.0
    )
    
    alternative: str = Field(
        default="two_sided",
        description="對立假設類型：two_sided, greater, less",
        example="two_sided"
    )
    
    alpha: float = Field(
        default=0.05,
        description="顯著水準",
        ge=0.001,
        le=0.1,
        example=0.05
    )


class HypothesisTestResult(BaseModel):
    """假設檢定結果模型"""
    
    test_statistic: float = Field(description="檢定統計量")
    p_value: float = Field(description="p 值")
    critical_value: Union[float, List[float]] = Field(description="臨界值")
    degrees_of_freedom: Optional[int] = Field(description="自由度")
    reject_null: bool = Field(description="是否拒絕虛無假設")
    conclusion: str = Field(description="檢定結論")
    effect_size: Optional[float] = Field(description="效應量")
```

#### 任務 4.2：建立統計服務邏輯
**預計時間：2 小時**

```python
# app/services/statistics.py
import numpy as np
from scipy import stats
from typing import List, Union, Optional, Dict, Any

from app.models.statistics import (
    DescriptiveStatistics,
    HypothesisTestResult,
    StatisticalDataRequest,
    HypothesisTestRequest
)


class StatisticsService:
    """統計分析服務類別"""
    
    @staticmethod
    def calculate_descriptive_statistics(
        data: List[Union[int, float]], 
        confidence_level: float = 0.95
    ) -> DescriptiveStatistics:
        """計算描述性統計"""
        
        np_data = np.array(data)
        n = len(np_data)
        
        # 基本統計量
        mean_val = float(np.mean(np_data))
        median_val = float(np.median(np_data))
        std_val = float(np.std(np_data, ddof=1))  # 樣本標準差
        var_val = float(np.var(np_data, ddof=1))   # 樣本變異數
        
        # 分位數
        q1 = float(np.percentile(np_data, 25))
        q3 = float(np.percentile(np_data, 75))
        
        # 眾數（可能不存在）
        mode_result = stats.mode(np_data, keepdims=False)
        mode_val = float(mode_result.mode) if mode_result.count > 1 else None
        
        # 形狀統計量
        skew_val = float(stats.skew(np_data))
        kurtosis_val = float(stats.kurtosis(np_data))
        
        # 信賴區間
        alpha = 1 - confidence_level
        t_critical = stats.t.ppf(1 - alpha/2, df=n-1)
        margin_error = t_critical * (std_val / np.sqrt(n))
        ci_lower = mean_val - margin_error
        ci_upper = mean_val + margin_error
        
        return DescriptiveStatistics(
            count=n,
            mean=mean_val,
            median=median_val,
            mode=mode_val,
            std_dev=std_val,
            variance=var_val,
            min_value=float(np.min(np_data)),
            max_value=float(np.max(np_data)),
            range_value=float(np.ptp(np_data)),
            q1=q1,
            q3=q3,
            iqr=q3 - q1,
            skewness=skew_val,
            kurtosis=kurtosis_val,
            confidence_interval={
                "lower": ci_lower,
                "upper": ci_upper,
                "level": confidence_level
            }
        )
    
    @staticmethod
    def perform_hypothesis_test(request: HypothesisTestRequest) -> HypothesisTestResult:
        """執行假設檢定"""
        
        data = np.array(request.sample_data)
        
        if request.test_type == "one_sample_t":
            # 單樣本 t 檢定
            t_stat, p_value = stats.ttest_1samp(
                data, 
                request.null_hypothesis_value,
                alternative=request.alternative
            )
            
            df = len(data) - 1
            alpha = request.alpha
            
            if request.alternative == "two_sided":
                critical_value = [
                    -stats.t.ppf(1 - alpha/2, df),
                    stats.t.ppf(1 - alpha/2, df)
                ]
            elif request.alternative == "greater":
                critical_value = stats.t.ppf(1 - alpha, df)
            else:  # less
                critical_value = -stats.t.ppf(1 - alpha, df)
            
            # Cohen's d 效應量
            effect_size = (np.mean(data) - request.null_hypothesis_value) / np.std(data, ddof=1)
            
            reject_null = p_value < alpha
            
            if reject_null:
                conclusion = f"在 α = {alpha} 水準下拒絕虛無假設"
            else:
                conclusion = f"在 α = {alpha} 水準下不拒絕虛無假設"
            
            return HypothesisTestResult(
                test_statistic=float(t_stat),
                p_value=float(p_value),
                critical_value=critical_value,
                degrees_of_freedom=df,
                reject_null=reject_null,
                conclusion=conclusion,
                effect_size=float(effect_size)
            )
        
        else:
            raise ValueError(f"不支援的檢定類型: {request.test_type}")
```

#### 任務 4.3：建立統計 API 路由
**預計時間：1 小時**

```python
# app/api/statistics.py
from fastapi import APIRouter, HTTPException
from typing import List, Union

from app.models.statistics import (
    StatisticalDataRequest,
    DescriptiveStatistics,
    HypothesisTestRequest,
    HypothesisTestResult
)
from app.services.statistics import StatisticsService

router = APIRouter(prefix="/statistics", tags=["統計分析"])


@router.post(
    "/descriptive",
    response_model=DescriptiveStatistics,
    operation_id="calculate_descriptive_statistics",
    summary="計算描述性統計",
    description="計算給定資料的完整描述性統計，包含中心趨勢、變異度量、分布形狀等指標"
)
async def calculate_descriptive_statistics(
    request: StatisticalDataRequest
) -> DescriptiveStatistics:
    """計算描述性統計量"""
    try:
        return StatisticsService.calculate_descriptive_statistics(
            data=request.data,
            confidence_level=request.confidence_level
        )
    except Exception as e:
        raise HTTPException(
            status_code=400,
            detail=f"計算描述性統計時發生錯誤: {str(e)}"
        )


@router.post(
    "/hypothesis-test",
    response_model=HypothesisTestResult,
    operation_id="perform_hypothesis_test",
    summary="執行假設檢定",
    description="執行各種統計假設檢定，包含單樣本 t 檢定等"
)
async def perform_hypothesis_test(
    request: HypothesisTestRequest
) -> HypothesisTestResult:
    """執行假設檢定"""
    try:
        return StatisticsService.perform_hypothesis_test(request)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        raise HTTPException(
            status_code=500,
            detail=f"執行假設檢定時發生錯誤: {str(e)}"
        )


@router.get(
    "/supported-tests",
    operation_id="get_supported_tests",
    summary="取得支援的檢定類型",
    description="列出目前支援的所有統計檢定類型"
)
async def get_supported_tests():
    """取得支援的檢定類型"""
    return {
        "supported_tests": [
            {
                "type": "one_sample_t",
                "name": "單樣本 t 檢定",
                "description": "檢定單一樣本平均數是否等於特定數值"
            }
        ]
    }
```

### 第 5 天：Docker 化與本地部署

#### 任務 5.1：建立 Dockerfile
**預計時間：1.5 小時**

```dockerfile
# Dockerfile
# 多階段構建：Poetry 依賴管理
FROM python:3.11-slim AS requirements-stage

WORKDIR /tmp

# 安裝 Poetry
RUN pip install poetry

# 複製 Poetry 配置檔案
COPY ./pyproject.toml ./poetry.lock* /tmp/

# 匯出依賴到 requirements.txt
RUN poetry export -f requirements.txt --output requirements.txt --without-hashes

# 生產環境階段
FROM python:3.11-slim AS runtime

# 建立非 root 使用者
RUN addgroup --gid 1001 --system nonroot && \
    adduser --uid 1001 --system --group nonroot

# 設定工作目錄
WORKDIR /code

# 複製 requirements.txt
COPY --from=requirements-stage /tmp/requirements.txt /code/requirements.txt

# 安裝依賴
RUN pip install --no-cache-dir --upgrade -r /code/requirements.txt

# 複製應用程式程式碼
COPY --chown=nonroot:nonroot ./app /code/app

# 建立日誌目錄
RUN mkdir -p /code/logs && chown nonroot:nonroot /code/logs

# 切換到非 root 使用者
USER nonroot:nonroot

# 暴露埠號
EXPOSE 8000

# 健康檢查
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD python -c "import requests; requests.get('http://localhost:8000/health')" || exit 1

# 執行應用程式
CMD ["fastapi", "run", "app/main.py", "--host", "0.0.0.0", "--port", "8000"]
```

#### 任務 5.2：建立 docker-compose 配置
**預計時間：1 小時**

```yaml
# docker-compose.yml
version: '3.8'

services:
  fastapi-mcp:
    build: .
    container_name: fastapi-mcp-server
    ports:
      - "8000:8000"
    environment:
      - DEBUG=false
      - DATABASE_URL=sqlite:///./data/app.db
      - REDIS_URL=redis://redis:6379/0
    volumes:
      - app_data:/code/data
      - app_logs:/code/logs
    depends_on:
      - redis
    restart: unless-stopped
    networks:
      - mcp_network

  redis:
    image: redis:7-alpine
    container_name: mcp-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    networks:
      - mcp_network
    command: redis-server --appendonly yes

volumes:
  app_data:
  app_logs:
  redis_data:

networks:
  mcp_network:
    driver: bridge
```

#### 任務 5.3：建立開發用 docker-compose
**預計時間：30 分鐘**

```yaml
# docker-compose.dev.yml
version: '3.8'

services:
  fastapi-mcp:
    build: 
      context: .
      dockerfile: Dockerfile.dev
    container_name: fastapi-mcp-dev
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - RELOAD=true
    volumes:
      - .:/code
      - dev_logs:/code/logs
    depends_on:
      - redis
    networks:
      - mcp_dev_network

  redis:
    image: redis:7-alpine
    container_name: mcp-redis-dev
    ports:
      - "6379:6379"
    networks:
      - mcp_dev_network

volumes:
  dev_logs:

networks:
  mcp_dev_network:
    driver: bridge
```

```dockerfile
# Dockerfile.dev
FROM python:3.11-slim

WORKDIR /code

# 安裝 Poetry
RUN pip install poetry

# 複製 Poetry 配置
COPY pyproject.toml poetry.lock* ./

# 配置 Poetry（不建立虛擬環境）
RUN poetry config virtualenvs.create false

# 安裝依賴（包含開發依賴）
RUN poetry install --no-root

# 暴露埠號
EXPOSE 8000

# 開發模式執行
CMD ["fastapi", "dev", "app/main.py", "--host", "0.0.0.0", "--port", "8000"]
```

### 第 6 天：測試與品質保證

#### 任務 6.1：建立單元測試
**預計時間：2 小時**

```python
# tests/unit/test_statistics_service.py
import pytest
import numpy as np

from app.services.statistics import StatisticsService
from app.models.statistics import HypothesisTestRequest


class TestStatisticsService:
    """統計服務單元測試"""
    
    def test_descriptive_statistics_basic(self):
        """測試基本描述性統計計算"""
        data = [1, 2, 3, 4, 5]
        result = StatisticsService.calculate_descriptive_statistics(data)
        
        assert result.count == 5
        assert result.mean == 3.0
        assert result.median == 3.0
        assert abs(result.std_dev - 1.5811) < 0.001
        assert result.min_value == 1.0
        assert result.max_value == 5.0
    
    def test_descriptive_statistics_single_value(self):
        """測試單一數值的描述性統計"""
        data = [5.0]
        result = StatisticsService.calculate_descriptive_statistics(data)
        
        assert result.count == 1
        assert result.mean == 5.0
        assert result.median == 5.0
        assert result.std_dev == 0.0  # 單一值標準差為 0
    
    def test_hypothesis_test_one_sample_t(self):
        """測試單樣本 t 檢定"""
        # 已知結果的測試資料
        data = [2.1, 2.3, 1.9, 2.0, 2.2, 2.4, 1.8, 2.1, 2.0, 2.2]
        
        request = HypothesisTestRequest(
            sample_data=data,
            test_type="one_sample_t",
            null_hypothesis_value=2.0,
            alternative="two_sided",
            alpha=0.05
        )
        
        result = StatisticsService.perform_hypothesis_test(request)
        
        assert isinstance(result.test_statistic, float)
        assert isinstance(result.p_value, float)
        assert 0 <= result.p_value <= 1
        assert result.degrees_of_freedom == 9
        assert isinstance(result.reject_null, bool)
    
    def test_hypothesis_test_invalid_type(self):
        """測試不支援的檢定類型"""
        request = HypothesisTestRequest(
            sample_data=[1, 2, 3],
            test_type="invalid_test",
            null_hypothesis_value=0
        )
        
        with pytest.raises(ValueError):
            StatisticsService.perform_hypothesis_test(request)
```

#### 任務 6.2：建立整合測試
**預計時間：1.5 小時**

```python
# tests/integration/test_api_endpoints.py
import pytest
from fastapi.testclient import TestClient

from app.main import app

client = TestClient(app)


class TestStatisticsAPI:
    """統計 API 整合測試"""
    
    def test_root_endpoint(self):
        """測試根端點"""
        response = client.get("/")
        assert response.status_code == 200
        
        data = response.json()
        assert "service" in data
        assert "version" in data
        assert "status" in data
        assert data["status"] == "running"
    
    def test_health_check(self):
        """測試健康檢查端點"""
        response = client.get("/health")
        assert response.status_code == 200
        
        data = response.json()
        assert data["status"] == "healthy"
    
    def test_descriptive_statistics_endpoint(self):
        """測試描述性統計端點"""
        payload = {
            "data": [1, 2, 3, 4, 5],
            "confidence_level": 0.95
        }
        
        response = client.post("/statistics/descriptive", json=payload)
        assert response.status_code == 200
        
        data = response.json()
        assert "count" in data
        assert "mean" in data
        assert "median" in data
        assert data["count"] == 5
        assert data["mean"] == 3.0
    
    def test_hypothesis_test_endpoint(self):
        """測試假設檢定端點"""
        payload = {
            "sample_data": [2.1, 2.3, 1.9, 2.0, 2.2],
            "test_type": "one_sample_t",
            "null_hypothesis_value": 2.0,
            "alternative": "two_sided",
            "alpha": 0.05
        }
        
        response = client.post("/statistics/hypothesis-test", json=payload)
        assert response.status_code == 200
        
        data = response.json()
        assert "test_statistic" in data
        assert "p_value" in data
        assert "reject_null" in data
    
    def test_supported_tests_endpoint(self):
        """測試支援的檢定類型端點"""
        response = client.get("/statistics/supported-tests")
        assert response.status_code == 200
        
        data = response.json()
        assert "supported_tests" in data
        assert len(data["supported_tests"]) > 0
    
    def test_invalid_data_handling(self):
        """測試無效資料處理"""
        payload = {
            "data": [],  # 空資料陣列
            "confidence_level": 0.95
        }
        
        response = client.post("/statistics/descriptive", json=payload)
        assert response.status_code == 422  # 驗證錯誤
```

#### 任務 6.3：建立測試腳本
**預計時間：30 分鐘**

```bash
#!/bin/bash
# scripts/run_tests.sh

set -e

echo "執行程式碼品質檢查..."

# 執行 Ruff 檢查
echo "執行 Ruff 程式碼檢查..."
poetry run ruff check .

# 執行 Ruff 格式化
echo "執行 Ruff 程式碼格式化..."
poetry run ruff format .

# 執行 MyPy 類型檢查
echo "執行 MyPy 類型檢查..."
poetry run mypy app/

# 執行測試
echo "執行單元測試..."
poetry run pytest tests/ -v --cov=app --cov-report=term-missing

echo "所有檢查完成！"
```

### 第 7 天：MCP 整合測試與文件

#### 任務 7.1：MCP 功能驗證
**預計時間：2 小時**

```python
# tests/integration/test_mcp_integration.py
import pytest
import json
from fastapi.testclient import TestClient

from app.main import app

client = TestClient(app)


class TestMCPIntegration:
    """MCP 整合測試"""
    
    def test_mcp_endpoint_exists(self):
        """測試 MCP 端點是否存在"""
        response = client.get("/mcp")
        # MCP 端點應該回應特定的 MCP 協議格式
        assert response.status_code in [200, 405]  # GET 可能不被支援
    
    def test_mcp_tools_discovery(self):
        """測試 MCP 工具發現功能"""
        # 這裡需要根據實際的 MCP 協議實作來測試
        # 通常會透過 POST 請求來查詢可用的工具
        mcp_request = {
            "jsonrpc": "2.0",
            "method": "tools/list",
            "id": 1
        }
        
        response = client.post("/mcp", json=mcp_request)
        
        # 檢查回應格式符合 MCP 規範
        if response.status_code == 200:
            data = response.json()
            assert "result" in data or "error" in data
    
    def test_fastapi_endpoints_as_mcp_tools(self):
        """測試 FastAPI 端點是否正確轉換為 MCP 工具"""
        # 檢查統計端點是否可透過 MCP 呼叫
        mcp_call = {
            "jsonrpc": "2.0",
            "method": "tools/call",
            "params": {
                "name": "calculate_descriptive_statistics",
                "arguments": {
                    "data": [1, 2, 3, 4, 5],
                    "confidence_level": 0.95
                }
            },
            "id": 2
        }
        
        response = client.post("/mcp", json=mcp_call)
        
        # 驗證 MCP 呼叫結果
        if response.status_code == 200:
            data = response.json()
            if "result" in data:
                result = data["result"]
                # 檢查統計結果是否正確
                assert "content" in result
```

#### 任務 7.2：建立部署指南
**預計時間：1 小時**

```markdown
# 部署指南.md

## FastAPI MCP Server 部署指南

### 本地開發環境

#### 1. 環境準備
```bash
# 安裝 Python 3.11+
python --version

# 安裝 Poetry
curl -sSL https://install.python-poetry.org | python3 -

# 安裝專案依賴
poetry install
```

#### 2. 環境變數設定
```bash
# 複製環境變數範本
cp .env.example .env

# 根據需求修改 .env 檔案
```

#### 3. 執行應用程式
```bash
# 開發模式
poetry run fastapi dev app/main.py

# 或使用 Python
poetry run python -m app.main
```

### Docker 部署

#### 1. 單容器部署
```bash
# 建立 Docker 映像
docker build -t fastapi-mcp-server .

# 執行容器
docker run -p 8000:8000 fastapi-mcp-server
```

#### 2. Docker Compose 部署
```bash
# 生產環境
docker-compose up -d

# 開發環境
docker-compose -f docker-compose.dev.yml up
```

### MCP 客戶端配置

#### Claude Desktop 設定
```json
{
  "mcpServers": {
    "fastapi-statistics": {
      "url": "http://localhost:8000/mcp"
    }
  }
}
```

#### 使用 mcp-remote
```json
{
  "mcpServers": {
    "fastapi-statistics": {
      "command": "npx",
      "args": [
        "mcp-remote",
        "http://localhost:8000/mcp"
      ]
    }
  }
}
```

### 測試部署

```bash
# 健康檢查
curl http://localhost:8000/health

# API 文件
open http://localhost:8000/docs

# 測試統計功能
curl -X POST http://localhost:8000/statistics/descriptive \
  -H "Content-Type: application/json" \
  -d '{"data": [1,2,3,4,5], "confidence_level": 0.95}'
```
```

#### 任務 7.3：建立 README 文件
**預計時間：1 小時**

```markdown
# README.md

# FastAPI MCP Server

基於 Model Context Protocol (MCP) 2025 最新標準的統計分析與機器學習推論服務平台。

## 功能特色

- ✅ **零配置 MCP 整合**：使用官方 `fastapi-mcp` 套件
- ✅ **現代 Python 技術棧**：FastAPI + Pydantic + Poetry
- ✅ **統計分析服務**：描述性統計、假設檢定
- ✅ **Docker 化部署**：生產就緒的容器配置
- ✅ **完整測試覆蓋**：單元測試 + 整合測試
- ✅ **自動化品質控制**：Ruff + MyPy + Pre-commit

## 快速開始

### 前置需求
- Python 3.11+
- Poetry
- Docker (可選)

### 安裝與執行

1. **克隆專案**
   ```bash
   git clone <repository-url>
   cd fastapi-mcp-server
   ```

2. **安裝依賴**
   ```bash
   poetry install
   ```

3. **設定環境變數**
   ```bash
   cp .env.example .env
   # 編輯 .env 檔案
   ```

4. **執行開發伺服器**
   ```bash
   poetry run fastapi dev app/main.py
   ```

5. **訪問服務**
   - API 文件: http://localhost:8000/docs
   - 健康檢查: http://localhost:8000/health
   - MCP 端點: http://localhost:8000/mcp

## API 端點

### 統計分析
- `POST /statistics/descriptive` - 計算描述性統計
- `POST /statistics/hypothesis-test` - 執行假設檢定
- `GET /statistics/supported-tests` - 取得支援的檢定類型

### 系統端點
- `GET /` - 服務資訊
- `GET /health` - 健康檢查

## MCP 整合

本服務支援標準的 Model Context Protocol，可與支援 MCP 的 AI 應用程式整合。

### 客戶端配置範例

```json
{
  "mcpServers": {
    "statistics-server": {
      "url": "http://localhost:8000/mcp"
    }
  }
}
```

## 開發指南

### 執行測試
```bash
# 全部測試
poetry run pytest

# 含覆蓋率報告
poetry run pytest --cov=app

# 程式碼品質檢查
poetry run ruff check .
poetry run mypy app/
```

### Docker 開發
```bash
# 開發環境
docker-compose -f docker-compose.dev.yml up

# 生產環境
docker-compose up -d
```

## 技術架構

- **Web 框架**: FastAPI 0.115+
- **MCP 整合**: fastapi-mcp
- **資料驗證**: Pydantic v2
- **統計計算**: NumPy, SciPy
- **容器化**: Docker + Docker Compose
- **測試框架**: pytest
- **程式碼品質**: Ruff + MyPy

## 貢獻指南

1. Fork 此專案
2. 建立功能分支 (`git checkout -b feature/amazing-feature`)
3. 提交變更 (`git commit -m 'Add amazing feature'`)
4. 推送至分支 (`git push origin feature/amazing-feature`)
5. 建立 Pull Request

## 授權條款

此專案採用 MIT 授權條款。
```

## 第一週完成檢核清單

### 開發環境 ✅
- [ ] Poetry 安裝與專案初始化
- [ ] Git 版本控制設置
- [ ] 開發工具配置 (Ruff, MyPy, Pre-commit)

### 核心功能 ✅
- [ ] FastAPI 應用程式架構
- [ ] fastapi-mcp 整合配置
- [ ] 基礎統計 API 實作
- [ ] 設定管理系統

### 容器化部署 ✅
- [ ] 生產級 Dockerfile
- [ ] Docker Compose 配置
- [ ] 開發環境容器配置

### 測試與品質 ✅
- [ ] 單元測試撰寫
- [ ] 整合測試實作
- [ ] MCP 功能驗證
- [ ] 程式碼覆蓋率 > 80%

### 文件與部署 ✅
- [ ] API 文件自動生成
- [ ] 部署指南撰寫
- [ ] README 完整說明
- [ ] MCP 客戶端配置範例

## 預期產出

完成第一週任務後，你將擁有：

1. **可運行的 FastAPI MCP Server** - 支援基礎統計分析功能
2. **完整的開發環境** - 含程式碼品質控制與測試框架
3. **生產就緒的部署配置** - Docker 容器化與 Compose 編排
4. **MCP 協議整合** - 可與支援 MCP 的 AI 應用程式互動
5. **完善的文件** - 包含部署指南、API 文件與開發說明

此基礎將為後續週次的進階功能開發（時間序列分析、機器學習模型、資料視覺化等）提供穩固的架構支撐。