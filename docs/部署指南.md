# ğŸš€ FastAPI MCP Server éƒ¨ç½²æŒ‡å—

æœ¬æ–‡æª”æä¾›å®Œæ•´çš„éƒ¨ç½²èªªæ˜ï¼Œé©ç”¨æ–¼é–‹ç™¼ã€æ¸¬è©¦å’Œç”Ÿç”¢ç’°å¢ƒã€‚

## ğŸ“‹ éƒ¨ç½²å‰æª¢æŸ¥æ¸…å–®

### âœ… **ç³»çµ±éœ€æ±‚**
- Docker Engine 20.0+
- Docker Compose 2.0+
- å¯ç”¨è¨˜æ†¶é«”: æœ€å°‘ 2GB
- å¯ç”¨ç£ç¢Ÿç©ºé–“: æœ€å°‘ 5GB
- ç¶²è·¯é€£æ¥: éœ€è¦ä¸‹è¼‰ Docker images

### âœ… **ç’°å¢ƒæº–å‚™**
```bash
# æª¢æŸ¥ Docker ç‰ˆæœ¬
docker --version
docker-compose --version

# æª¢æŸ¥ç³»çµ±è³‡æº
docker system df
free -h
```

## ğŸ³ éƒ¨ç½²é¸é …

### 1. ğŸ­ **å®Œæ•´ç”Ÿç”¢ç’°å¢ƒéƒ¨ç½²**

ä½¿ç”¨ `docker-compose.yml` éƒ¨ç½²åŒ…å«æ‰€æœ‰æœå‹™çš„å®Œæ•´ç’°å¢ƒã€‚

```bash
# å…‹éš†å°ˆæ¡ˆ
git clone <repository-url>
cd fastapi_mcp_server

# å•Ÿå‹•æ‰€æœ‰æœå‹™
docker-compose up -d

# æª¢æŸ¥æœå‹™ç‹€æ…‹
docker-compose ps
```

**åŒ…å«æœå‹™**:
- âœ… FastAPI MCP Server (ä¸»æ‡‰ç”¨)
- âœ… TimescaleDB (æ™‚åºè³‡æ–™åº«)
- âœ… Redis (å¿«å–æœå‹™)

**é è¨­ç«¯å£**:
- ğŸŒ FastAPI: http://localhost:8000
- ğŸ—„ï¸ TimescaleDB: localhost:5432
- ğŸ”´ Redis: localhost:6379

### 2. ğŸ”§ **é–‹ç™¼ç’°å¢ƒéƒ¨ç½²**

ä½¿ç”¨ `docker-compose.dev.yml` é€²è¡Œé–‹ç™¼ã€‚

```bash
# é–‹ç™¼ç’°å¢ƒå•Ÿå‹•
docker-compose -f docker-compose.dev.yml up -d

# æŸ¥çœ‹å³æ™‚æ—¥èªŒ
docker-compose -f docker-compose.dev.yml logs -f fastapi-mcp
```

**ç‰¹é»**:
- ğŸ”„ ç¨‹å¼ç¢¼è®Šæ›´è‡ªå‹•é‡è¼‰
- ğŸ“ è©³ç´°é™¤éŒ¯æ—¥èªŒ
- ğŸ—„ï¸ åªåŒ…å«å¿…è¦çš„ Redis æœå‹™

### 3. ğŸ—„ï¸ **ç´”è³‡æ–™åº«ç’°å¢ƒ**

ä½¿ç”¨ `docker-compose.timescale.yml` åªå•Ÿå‹•è³‡æ–™åº«æœå‹™ã€‚

```bash
# åªå•Ÿå‹•è³‡æ–™åº«
docker-compose -f docker-compose.timescale.yml up -d

# æœ¬åœ°é‹è¡Œ FastAPI
poetry install
poetry run uvicorn app.main:app --reload
```

**ä½¿ç”¨å ´æ™¯**:
- æœ¬åœ°é–‹ç™¼é™¤éŒ¯
- è³‡æ–™åº«ç¶­è­·
- æ•ˆèƒ½æ¸¬è©¦

## âš™ï¸ ç’°å¢ƒé…ç½®

### ç’°å¢ƒè®Šæ•¸é…ç½®

å‰µå»º `.env` æ–‡ä»¶ï¼ˆå¯é¸ï¼‰:

```bash
# .env ç¯„ä¾‹
DEBUG=false
DATABASE_URL=postgresql://postgres:password@timescaledb:5432/fastapi_mcp
REDIS_URL=redis://:redis_password@redis:6379/0
HOST=0.0.0.0
PORT=8000

# æ‡‰ç”¨è¨­å®š
APP_NAME="FastAPI MCP Server"
APP_VERSION="2.0.0"

# CORS è¨­å®š
CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080"]
```

### è³‡æ–™åº«é…ç½®

**TimescaleDB é è¨­è¨­å®š**:
```yaml
environment:
  - POSTGRES_DB=fastapi_mcp
  - POSTGRES_USER=postgres
  - POSTGRES_PASSWORD=password
```

**Redis é è¨­è¨­å®š**:
```yaml
command: redis-server --appendonly yes --requirepass redis_password
```

## ğŸ”„ è³‡æ–™åº«åˆå§‹åŒ–

### é¸é … 1: è‡ªå‹•åˆå§‹åŒ– (é è¨­)
æ‡‰ç”¨å•Ÿå‹•æ™‚æœƒè‡ªå‹•å»ºç«‹æ‰€éœ€çš„è³‡æ–™åº«è¡¨æ ¼ã€‚

### é¸é … 2: Alembic é·ç§» (æ¨è–¦)
ä½¿ç”¨ Alembic é€²è¡Œè³‡æ–™åº« schema ç®¡ç†ï¼š

```bash
# åœ¨æœ‰è³‡æ–™åº«é€£æ¥çš„ç’°å¢ƒåŸ·è¡Œ
alembic upgrade head

# æŸ¥çœ‹é·ç§»ç‹€æ…‹
alembic current

# æŸ¥çœ‹é·ç§»æ­·å²
alembic history
```

è©³ç´°æ­¥é©Ÿè«‹åƒè€ƒï¼š[`è½‰æ›è‡³Alembicé·ç§»ç³»çµ±æŒ‡å¼•.md`](./è½‰æ›è‡³Alembicé·ç§»ç³»çµ±æŒ‡å¼•.md)

## ğŸŒ æœå‹™é©—è­‰

### API ç«¯é»æ¸¬è©¦

```bash
# å¥åº·æª¢æŸ¥
curl http://localhost:8000/health

# æ ¹ç«¯é»
curl http://localhost:8000/

# API æ–‡æª”
curl http://localhost:8000/docs

# MCP ç«¯é»
curl http://localhost:8000/mcp
```

### æœå‹™ç‹€æ…‹æª¢æŸ¥

```bash
# æª¢æŸ¥æ‰€æœ‰å®¹å™¨
docker-compose ps

# æŸ¥çœ‹æœå‹™æ—¥èªŒ
docker-compose logs fastapi-mcp
docker-compose logs timescaledb
docker-compose logs redis

# æª¢æŸ¥æœå‹™å¥åº·ç‹€æ…‹
docker-compose exec fastapi-mcp curl localhost:8000/health
```

## ğŸ“Š ç›£æ§èˆ‡æ—¥èªŒ

### æ‡‰ç”¨ç›£æ§ç«¯é»

```bash
# MCP æœå‹™æŒ‡æ¨™
curl http://localhost:8000/monitoring/mcp/metrics

# çµæ§‹åŒ–æ—¥èªŒ
curl http://localhost:8000/monitoring/mcp/logs

# ç³»çµ±å¥åº·ç‹€æ…‹
curl http://localhost:8000/health
```

### æ—¥èªŒç®¡ç†

```bash
# æŸ¥çœ‹å³æ™‚æ—¥èªŒ
docker-compose logs -f fastapi-mcp

# æŸ¥çœ‹ç‰¹å®šæ™‚é–“ç¯„åœæ—¥èªŒ
docker-compose logs --since="2h" fastapi-mcp

# åŒ¯å‡ºæ—¥èªŒ
docker-compose logs --no-color > app_logs.txt
```

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

#### 1. å®¹å™¨å•Ÿå‹•å¤±æ•—

```bash
# æª¢æŸ¥å®¹å™¨ç‹€æ…‹
docker-compose ps

# æŸ¥çœ‹è©³ç´°éŒ¯èª¤
docker-compose logs <service-name>

# é‡æ–°å»ºç½®æ˜ åƒ
docker-compose build --no-cache
docker-compose up -d
```

#### 2. è³‡æ–™åº«é€£æ¥å•é¡Œ

```bash
# æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦å°±ç·’
docker-compose exec timescaledb pg_isready -U postgres

# æ¸¬è©¦è³‡æ–™åº«é€£æ¥
docker-compose exec timescaledb psql -U postgres -d fastapi_mcp -c "SELECT 1;"

# é‡ç½®è³‡æ–™åº«
docker-compose down -v
docker-compose up -d
```

#### 3. Redis é€£æ¥å•é¡Œ

```bash
# æ¸¬è©¦ Redis é€£æ¥
docker-compose exec redis redis-cli ping

# æª¢æŸ¥ Redis èªè­‰
docker-compose exec redis redis-cli -a redis_password ping

# æŸ¥çœ‹ Redis è¨˜æ†¶é«”ä½¿ç”¨
docker-compose exec redis redis-cli -a redis_password info memory
```

#### 4. ç«¯å£è¡çª

```bash
# æª¢æŸ¥ç«¯å£ä½¿ç”¨ç‹€æ³
netstat -tulpn | grep :8000
netstat -tulpn | grep :5432
netstat -tulpn | grep :6379

# ä¿®æ”¹ docker-compose.yml ä¸­çš„ç«¯å£å°æ‡‰
ports:
  - "8001:8000"  # ä¿®æ”¹ä¸»æ©Ÿç«¯å£
```

## ğŸ”’ å®‰å…¨æ€§é…ç½®

### ç”Ÿç”¢ç’°å¢ƒå®‰å…¨å»ºè­°

1. **ä¿®æ”¹é è¨­å¯†ç¢¼**:
```yaml
environment:
  - POSTGRES_PASSWORD=<å¼·å¯†ç¢¼>
  - REDIS_PASSWORD=<å¼·å¯†ç¢¼>
```

2. **é™åˆ¶ç¶²è·¯è¨ªå•**:
```yaml
networks:
  mcp_network:
    driver: bridge
    internal: true  # é™åˆ¶å¤–éƒ¨è¨ªå•
```

3. **ä½¿ç”¨é root ä½¿ç”¨è€…**:
```dockerfile
USER nonroot  # å·²åœ¨ Dockerfile ä¸­å¯¦ä½œ
```

4. **å•Ÿç”¨ HTTPS**:
```bash
# ä½¿ç”¨ nginx æˆ– Traefik ä½œç‚ºåå‘ä»£ç†
# é…ç½® SSL æ†‘è­‰
```

## ğŸ“ˆ æ•ˆèƒ½å„ªåŒ–

### è³‡æ–™åº«æ•ˆèƒ½èª¿å„ª

```sql
-- TimescaleDB ç‰¹å®šå„ªåŒ–
SELECT create_hypertable('timeseries_data', 'timestamp');
SELECT add_retention_policy('timeseries_data', INTERVAL '30 days');
```

### Redis å¿«å–å„ªåŒ–

```yaml
# docker-compose.yml ä¸­çš„ Redis é…ç½®
command: >
  redis-server 
  --maxmemory 256mb 
  --maxmemory-policy allkeys-lru
  --appendonly yes
```

### æ‡‰ç”¨æ•ˆèƒ½èª¿å„ª

```bash
# å¢åŠ  worker æ•¸é‡
uvicorn app.main:app --workers 4 --host 0.0.0.0 --port 8000

# è¨­å®šé©ç•¶çš„è³‡æ–™åº«é€£æ¥æ± 
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

## ğŸ”„ æ›´æ–°èˆ‡ç¶­è­·

### æ‡‰ç”¨æ›´æ–°æµç¨‹

```bash
# 1. å‚™ä»½è³‡æ–™
docker-compose exec timescaledb pg_dump -U postgres fastapi_mcp > backup.sql

# 2. åœæ­¢æœå‹™
docker-compose down

# 3. æ›´æ–°ç¨‹å¼ç¢¼
git pull origin main

# 4. é‡æ–°å»ºç½®
docker-compose build

# 5. åŸ·è¡Œè³‡æ–™åº«é·ç§»ï¼ˆå¦‚æœä½¿ç”¨ Alembicï¼‰
docker-compose run --rm fastapi-mcp alembic upgrade head

# 6. é‡æ–°å•Ÿå‹•
docker-compose up -d
```

### å®šæœŸç¶­è­·ä»»å‹™

```bash
# æ¸…ç†æœªä½¿ç”¨çš„ Docker è³‡æº
docker system prune -a

# å‚™ä»½è³‡æ–™åº«
docker-compose exec timescaledb pg_dump -U postgres fastapi_mcp > "backup_$(date +%Y%m%d).sql"

# æ¸…ç†æ‡‰ç”¨æ—¥èªŒ
docker-compose exec fastapi-mcp find /code/logs -name "*.log" -mtime +7 -delete
```

## ğŸ“Š ç›£æ§èˆ‡å‘Šè­¦

### åŸºç¤ç›£æ§æŒ‡æ¨™

```bash
# CPU å’Œè¨˜æ†¶é«”ä½¿ç”¨é‡
docker stats

# ç£ç¢Ÿä½¿ç”¨é‡
docker system df

# æœå‹™å¥åº·ç‹€æ…‹
curl -f http://localhost:8000/health || echo "Service is down"
```

### é«˜ç´šç›£æ§ (å¯é¸)

æ•´åˆ Prometheus + Grafana:

```yaml
# docker-compose.monitoring.yml (é¡å¤–æª”æ¡ˆ)
prometheus:
  image: prom/prometheus
  ports:
    - "9090:9090"
  
grafana:
  image: grafana/grafana
  ports:
    - "3000:3000"
```