# 🚀 FastAPI MCP Server 部署指南

本文檔提供完整的部署說明，適用於開發、測試和生產環境。

## 📋 部署前檢查清單

### ✅ **系統需求**
- Docker Engine 20.0+
- Docker Compose 2.0+
- 可用記憶體: 最少 2GB
- 可用磁碟空間: 最少 5GB
- 網路連接: 需要下載 Docker images

### ✅ **環境準備**
```bash
# 檢查 Docker 版本
docker --version
docker-compose --version

# 檢查系統資源
docker system df
free -h
```

## 🐳 部署選項

### 1. 🏭 **完整生產環境部署**

使用 `docker-compose.yml` 部署包含所有服務的完整環境。

```bash
# 克隆專案
git clone <repository-url>
cd fastapi_mcp_server

# 啟動所有服務
docker-compose up -d

# 檢查服務狀態
docker-compose ps
```

**包含服務**:
- ✅ FastAPI MCP Server (主應用)
- ✅ TimescaleDB (時序資料庫)
- ✅ Redis (快取服務)

**預設端口**:
- 🌐 FastAPI: http://localhost:8000
- 🗄️ TimescaleDB: localhost:5432
- 🔴 Redis: localhost:6379

### 2. 🔧 **開發環境部署**

使用 `docker-compose.dev.yml` 進行開發。

```bash
# 開發環境啟動
docker-compose -f docker-compose.dev.yml up -d

# 查看即時日誌
docker-compose -f docker-compose.dev.yml logs -f fastapi-mcp
```

**特點**:
- 🔄 程式碼變更自動重載
- 📝 詳細除錯日誌
- 🗄️ 只包含必要的 Redis 服務

### 3. 🗄️ **純資料庫環境**

使用 `docker-compose.timescale.yml` 只啟動資料庫服務。

```bash
# 只啟動資料庫
docker-compose -f docker-compose.timescale.yml up -d

# 本地運行 FastAPI
poetry install
poetry run uvicorn app.main:app --reload
```

**使用場景**:
- 本地開發除錯
- 資料庫維護
- 效能測試

## ⚙️ 環境配置

### 環境變數配置

創建 `.env` 文件（可選）:

```bash
# .env 範例
DEBUG=false
DATABASE_URL=postgresql://postgres:password@timescaledb:5432/fastapi_mcp
REDIS_URL=redis://:redis_password@redis:6379/0
HOST=0.0.0.0
PORT=8000

# 應用設定
APP_NAME="FastAPI MCP Server"
APP_VERSION="2.0.0"

# CORS 設定
CORS_ORIGINS=["http://localhost:3000", "http://localhost:8080"]
```

### 資料庫配置

**TimescaleDB 預設設定**:
```yaml
environment:
  - POSTGRES_DB=fastapi_mcp
  - POSTGRES_USER=postgres
  - POSTGRES_PASSWORD=password
```

**Redis 預設設定**:
```yaml
command: redis-server --appendonly yes --requirepass redis_password
```

## 🔄 資料庫初始化

### 選項 1: 自動初始化 (預設)
應用啟動時會自動建立所需的資料庫表格。

### 選項 2: Alembic 遷移 (推薦)
使用 Alembic 進行資料庫 schema 管理：

```bash
# 在有資料庫連接的環境執行
alembic upgrade head

# 查看遷移狀態
alembic current

# 查看遷移歷史
alembic history
```

詳細步驟請參考：[`轉換至Alembic遷移系統指引.md`](./轉換至Alembic遷移系統指引.md)

## 🌐 服務驗證

### API 端點測試

```bash
# 健康檢查
curl http://localhost:8000/health

# 根端點
curl http://localhost:8000/

# API 文檔
curl http://localhost:8000/docs

# MCP 端點
curl http://localhost:8000/mcp
```

### 服務狀態檢查

```bash
# 檢查所有容器
docker-compose ps

# 查看服務日誌
docker-compose logs fastapi-mcp
docker-compose logs timescaledb
docker-compose logs redis

# 檢查服務健康狀態
docker-compose exec fastapi-mcp curl localhost:8000/health
```

## 📊 監控與日誌

### 應用監控端點

```bash
# MCP 服務指標
curl http://localhost:8000/monitoring/mcp/metrics

# 結構化日誌
curl http://localhost:8000/monitoring/mcp/logs

# 系統健康狀態
curl http://localhost:8000/health
```

### 日誌管理

```bash
# 查看即時日誌
docker-compose logs -f fastapi-mcp

# 查看特定時間範圍日誌
docker-compose logs --since="2h" fastapi-mcp

# 匯出日誌
docker-compose logs --no-color > app_logs.txt
```

## 🔧 故障排除

### 常見問題與解決方案

#### 1. 容器啟動失敗

```bash
# 檢查容器狀態
docker-compose ps

# 查看詳細錯誤
docker-compose logs <service-name>

# 重新建置映像
docker-compose build --no-cache
docker-compose up -d
```

#### 2. 資料庫連接問題

```bash
# 檢查資料庫是否就緒
docker-compose exec timescaledb pg_isready -U postgres

# 測試資料庫連接
docker-compose exec timescaledb psql -U postgres -d fastapi_mcp -c "SELECT 1;"

# 重置資料庫
docker-compose down -v
docker-compose up -d
```

#### 3. Redis 連接問題

```bash
# 測試 Redis 連接
docker-compose exec redis redis-cli ping

# 檢查 Redis 認證
docker-compose exec redis redis-cli -a redis_password ping

# 查看 Redis 記憶體使用
docker-compose exec redis redis-cli -a redis_password info memory
```

#### 4. 端口衝突

```bash
# 檢查端口使用狀況
netstat -tulpn | grep :8000
netstat -tulpn | grep :5432
netstat -tulpn | grep :6379

# 修改 docker-compose.yml 中的端口對應
ports:
  - "8001:8000"  # 修改主機端口
```

## 🔒 安全性配置

### 生產環境安全建議

1. **修改預設密碼**:
```yaml
environment:
  - POSTGRES_PASSWORD=<強密碼>
  - REDIS_PASSWORD=<強密碼>
```

2. **限制網路訪問**:
```yaml
networks:
  mcp_network:
    driver: bridge
    internal: true  # 限制外部訪問
```

3. **使用非 root 使用者**:
```dockerfile
USER nonroot  # 已在 Dockerfile 中實作
```

4. **啟用 HTTPS**:
```bash
# 使用 nginx 或 Traefik 作為反向代理
# 配置 SSL 憑證
```

## 📈 效能優化

### 資料庫效能調優

```sql
-- TimescaleDB 特定優化
SELECT create_hypertable('timeseries_data', 'timestamp');
SELECT add_retention_policy('timeseries_data', INTERVAL '30 days');
```

### Redis 快取優化

```yaml
# docker-compose.yml 中的 Redis 配置
command: >
  redis-server 
  --maxmemory 256mb 
  --maxmemory-policy allkeys-lru
  --appendonly yes
```

### 應用效能調優

```bash
# 增加 worker 數量
uvicorn app.main:app --workers 4 --host 0.0.0.0 --port 8000

# 設定適當的資料庫連接池
DATABASE_POOL_SIZE=10
DATABASE_MAX_OVERFLOW=20
```

## 🔄 更新與維護

### 應用更新流程

```bash
# 1. 備份資料
docker-compose exec timescaledb pg_dump -U postgres fastapi_mcp > backup.sql

# 2. 停止服務
docker-compose down

# 3. 更新程式碼
git pull origin main

# 4. 重新建置
docker-compose build

# 5. 執行資料庫遷移（如果使用 Alembic）
docker-compose run --rm fastapi-mcp alembic upgrade head

# 6. 重新啟動
docker-compose up -d
```

### 定期維護任務

```bash
# 清理未使用的 Docker 資源
docker system prune -a

# 備份資料庫
docker-compose exec timescaledb pg_dump -U postgres fastapi_mcp > "backup_$(date +%Y%m%d).sql"

# 清理應用日誌
docker-compose exec fastapi-mcp find /code/logs -name "*.log" -mtime +7 -delete
```

## 📊 監控與告警

### 基礎監控指標

```bash
# CPU 和記憶體使用量
docker stats

# 磁碟使用量
docker system df

# 服務健康狀態
curl -f http://localhost:8000/health || echo "Service is down"
```

### 高級監控 (可選)

整合 Prometheus + Grafana:

```yaml
# docker-compose.monitoring.yml (額外檔案)
prometheus:
  image: prom/prometheus
  ports:
    - "9090:9090"
  
grafana:
  image: grafana/grafana
  ports:
    - "3000:3000"
```